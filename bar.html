<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https://images.unsplash.com https://garnetgrid.com https://poppin.garnetgrid.com; connect-src 'self'">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>POPPIN ‚Äî Bar Detail</title>
  <meta name="theme-color" content="#1A0A2E">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="img/icon-192.png">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="POPPIN">
  <meta property="og:image" content="https://poppin.garnetgrid.com/img/icon-512.png">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:image" content="https://poppin.garnetgrid.com/img/icon-512.png">
  <meta name="description"
    content="Live crowd levels, ratings, chat, and events at this bar. See what's poppin right now.">
  <meta property="og:title" content="POPPIN ‚Äî Bar Detail">
  <meta property="og:url" content="https://poppin.garnetgrid.com/bar.html">
  <link rel="canonical" href="https://poppin.garnetgrid.com/bar.html">
  <link rel="preconnect" href="https://images.unsplash.com">
  <link rel="stylesheet" href="css/style.css">
  <style>
    .bar-detail-hero {
      position: relative;
      border-radius: var(--radius-xl);
      overflow: hidden;
      height: 360px;
      margin-bottom: var(--space-xl);
    }

    .bar-detail-hero img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .bar-detail-hero .overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(to top, var(--bg-body) 0%, rgba(14, 5, 24, 0.3) 60%, transparent 100%);
    }

    .bar-detail-hero .content {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: var(--space-2xl);
      z-index: 2;
    }

    .bar-info-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: var(--space-xl);
    }

    .bar-stats-sidebar {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
    }

    .info-block {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
    }

    .info-block h4 {
      margin-bottom: var(--space-md);
      color: var(--gold-primary);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .comment-input-area {
      display: flex;
      gap: var(--space-sm);
      margin-top: var(--space-md);
    }

    .comment-input-area input {
      flex: 1;
    }

    @media(max-width:768px) {
      .bar-info-grid {
        grid-template-columns: 1fr;
      }

      .bar-detail-hero {
        height: 250px;
      }
    }
  </style>
</head>

<body>
  <div id="nav-root"></div>

  <main class="page-content">
    <div class="container">
      <div id="barDetail"></div>
    </div>
  </main>

  <div id="footer-root"></div>

  <script src="js/data.js"></script>
  <script src="js/membership.js"></script>
  <script src="js/chat.js"></script>
  <script src="js/app.js"></script>
  <script>
    initPage('dashboard');

    const params = new URLSearchParams(window.location.search);
    const barId = parseInt(params.get('id')) || 1;
    const bar = POPPIN.getBar(barId);
    const comments = POPPIN.getCommentsForBar(barId);
    const events = POPPIN.getEventsForBar(barId);
    const user = POPPIN.getCurrentUser();

    if (!bar) {
      document.getElementById('barDetail').innerHTML = '<p>Bar not found. <a href="dashboard.html">Back to Dashboard</a></p>';
    } else {
      document.title = `POPPIN ‚Äî ${bar.name}`;

      const crowdBars = Array.from({ length: 5 }, (_, i) => {
        const active = i < bar.crowdLevel;
        const high = bar.crowdLevel >= 4 && active;
        return `<div class="bar ${active ? 'active' : ''} ${high ? 'high' : ''}"></div>`;
      }).join('');

      const feedImg = getBarFeedImage(bar);

      document.getElementById('barDetail').innerHTML = `
        <!-- Hero -->
        <div class="bar-detail-hero">
          <img src="${feedImg}" alt="${bar.name}">
          <div class="overlay"></div>
          <div class="content">
            <div class="live-badge" style="position:static;display:inline-flex;margin-bottom:var(--space-sm)"><span class="dot"></span> LIVE</div>
            <h1 style="font-size:2rem;margin-bottom:4px">${bar.name}</h1>
            <p style="color:var(--text-secondary)">${bar.vibeEmoji} ${bar.vibeLabel} ¬∑ üìç ${bar.neighborhood} ¬∑ ${bar.checkedIn} people here</p>
          </div>
        </div>

        <div class="bar-info-grid">
          <!-- Left Column -->
          <div>
            <!-- Camera Feed (local) -->
            <div class="info-block" style="margin-bottom:var(--space-xl)">
              <h4>üìπ Live Feed</h4>
              <div style="position:relative; border-radius:var(--radius-md); overflow:hidden; height:300px; background:#000;">
                <img src="${feedImg}" alt="Live feed" style="width:100%;height:100%;object-fit:cover;filter:brightness(0.8) saturate(1.2);">
                <div class="live-badge" style="position:absolute;top:12px;left:12px;"><span class="dot"></span> LIVE ¬∑ ${bar.name}</div>
                <div style="position:absolute;bottom:12px;right:12px;background:rgba(0,0,0,0.7);padding:4px 10px;border-radius:var(--radius-sm);font-size:0.7rem;color:#fff;font-family:monospace;">
                  ${new Date().toLocaleTimeString()} EST
                </div>
              </div>
            </div>

            <!-- Chat Panel -->
            ${renderChatPanel(barId)}
          </div>

          <!-- Right Column -->
          <div class="bar-stats-sidebar">
            <!-- Quick Actions -->
            <div class="info-block" style="text-align:center">
              <button class="btn btn-gold btn-block btn-lg checkin-btn" id="checkinBtn" onclick="checkIn()">üìç I'm Here</button>
              <button class="btn btn-outline btn-block" style="margin-top: 8px; border-color: var(--accent-primary); color: var(--accent-primary);" onclick="viewWhosHere(${bar.id})">üëÄ See Who's Here</button>
              <div style="margin-top:var(--space-md); display:flex; gap:var(--space-sm); justify-content:center;">
                <button class="vote-btn" onclick="voteBar(${bar.id}, this)">üî• Vote ¬∑ ${bar.votesTonight}</button>
              </div>
            </div>

            <!-- Ratings -->
            <div class="info-block">
              <h4>üìä Ratings</h4>
              <div style="display:flex;justify-content:space-between;margin-bottom:var(--space-sm)">
                <span style="font-size:0.82rem;color:var(--text-secondary)">Tonight</span>
                <span class="rating-badge">‚≠ê ${bar.ratingTonight}</span>
              </div>
              <div style="display:flex;justify-content:space-between;margin-bottom:var(--space-md)">
                <span style="font-size:0.82rem;color:var(--text-secondary)">Overall</span>
                <span class="rating-badge">‚≠ê ${bar.ratingOverall}</span>
              </div>
              <div style="display:flex;justify-content:space-between">
                <span style="font-size:0.82rem;color:var(--text-secondary)">Crowd Level</span>
                <div class="crowd-meter"><div class="bars">${crowdBars}</div></div>
              </div>
            </div>

            <!-- Info -->
            <div class="info-block">
              <h4>üìç Details</h4>
              <p style="font-size:0.82rem;color:var(--text-secondary);margin-bottom:var(--space-sm)">${bar.address}</p>
              <p style="font-size:0.82rem;color:var(--text-secondary);margin-bottom:var(--space-sm)">üïê ${bar.hours}</p>
              <p style="font-size:0.82rem;color:var(--text-secondary);margin-bottom:var(--space-md)">${bar.description}</p>
              <div style="display:flex; flex-direction:column; gap:6px;">
                <div style="font-size:0.82rem;color:var(--text-secondary)"><strong>Age Vibe:</strong> <span style="color:var(--text-primary)">${bar.ageVibe || 'Mixed'}</span></div>
                <div style="font-size:0.82rem;color:var(--text-secondary)"><strong>Dress Code:</strong> <span style="color:var(--text-primary)" style="text-transform:capitalize">${bar.dressCode || 'Casual'}</span></div>
                <div style="font-size:0.82rem;color:var(--text-secondary)"><strong>Music:</strong> <span style="color:var(--text-primary)" style="text-transform:capitalize">${bar.musicGenre || 'Mixed'}</span></div>
              </div>
            </div>

            <!-- Specials -->
            <div class="info-block">
              <h4>üç∏ Tonight's Specials & Menu</h4>
              <p style="font-size:0.82rem;color:var(--gold-primary);margin-bottom:var(--space-sm)"><strong>Happy Hour:</strong> ${bar.happyHour || 'Check with bartender'}</p>
              <p style="font-size:0.82rem;color:var(--text-secondary);margin-bottom:var(--space-md)">${bar.specials}</p>
              ${bar.drinksMenu && bar.drinksMenu.length > 0 ? `
                <h5 style="font-size:0.8rem; margin-bottom:8px; color:var(--text-primary);">Signature Drinks</h5>
                <ul style="padding-left:16px; margin:0; font-size:0.82rem; color:var(--text-secondary); margin-bottom: 12px;">
                  ${bar.drinksMenu.map(d => `<li style="margin-bottom:4px;">${d}</li>`).join('')}
                </ul>
              ` : ''}
              <button class="btn btn-outline btn-block" id="redeemBtn" onclick="redeemDrink('${bar.name.replace(/'/g, "\\'")}')" style="margin-top: 8px;">üéüÔ∏è Redeem Drink (-1 Token)</button>
            </div>

            <!-- Events Here -->
            ${events.length > 0 ? `
            <div class="info-block">
              <h4>üéâ Upcoming Events</h4>
              ${events.map(ev => `
                <div style="padding:var(--space-sm) 0;border-bottom:1px solid rgba(155,89,182,0.1);font-size:0.82rem">
                  <div style="font-weight:600;color:var(--text-primary)">${ev.title}</div>
                  <div style="color:var(--text-muted)">${ev.month} ${ev.day} ¬∑ ${ev.time}</div>
                </div>
              `).join('')}
            </div>` : ''}
          </div>
        </div>
      `;
    }

    /* Initialize chat panel */
    if (typeof PoppinChat !== 'undefined') {
      loadChatHistory(barId);
      refreshCommentsList(barId);
      PoppinChat.startBotActivity(barId);
    }

    function checkIn() {
      const btn = document.getElementById('checkinBtn');
      btn.textContent = '‚úì Checked In';
      btn.classList.add('checked-in');
      btn.classList.remove('btn-gold');
      btn.classList.add('btn-primary');
      btn.disabled = true;
      showToast(`Checked in at ${bar.name}! üìç`);
    }

    function redeemDrink(barName) {
      Membership.requireToken(() => {
        Membership.logRedemption(barId, 'Signature Cocktail');
        const btn = document.getElementById('redeemBtn');
        btn.textContent = '‚úì Drink Redeemed';
        btn.classList.add('btn-primary');
        btn.classList.remove('btn-outline');
        btn.disabled = true;
        showToast(`Redeemed one signature cocktail at ${barName}! üç∏`);
      });
    }

    function viewWhosHere(barId) {
      Membership.requireFeature('whoIsHere', () => {
        window.location.href = `whos-here.html?id=${barId}`;
      });
    }
  </script>
  <script src="js/protect.js"></script>

    <!-- GarnetGrid Product Acknowledgement -->
    <div style="text-align:center;padding:1.2rem 0 1rem;opacity:0.7;margin-top:auto;">
        <a href="https://garnetgrid.com" target="_blank" rel="noopener"
            style="color:#aaa;font-size:0.72rem;text-decoration:none;display:inline-flex;align-items:center;gap:4px"
            title="Built by GarnetGrid">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14"
                style="width:14px;height:14px;min-width:14px">
                <defs>
                    <linearGradient id="gf1" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#9b1b30" />
                        <stop offset="100%" stop-color="#d4374a" />
                    </linearGradient>
                    <linearGradient id="gf2" x1="100%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" stop-color="#e63946" />
                        <stop offset="100%" stop-color="#7a1525" />
                    </linearGradient>
                    <linearGradient id="gf3" x1="50%" y1="0%" x2="50%" y2="100%">
                        <stop offset="0%" stop-color="#ff6b6b" />
                        <stop offset="100%" stop-color="#c0392b" />
                    </linearGradient>
                </defs>
                <style>
                    @keyframes facet-shimmer {
                        0%, 100% { opacity: 0 }
                        15% { opacity: .4 }
                        30% { opacity: 0 }
                    }
                    @keyframes gem-rotate {
                        0%, 100% { transform: rotate(0deg) scale(1) }
                        25% { transform: rotate(3deg) scale(1.02) }
                        75% { transform: rotate(-3deg) scale(1.02) }
                    }
                    @keyframes sparkle-pop {
                        0%, 100% { opacity: 0; transform: scale(0) }
                        50% { opacity: 1; transform: scale(1) }
                    }
                    .gem-body { transform-origin: 12px 12px; animation: gem-rotate 4s ease-in-out infinite }
                    .shimmer-1 { animation: facet-shimmer 3s ease-in-out infinite }
                    .shimmer-2 { animation: facet-shimmer 3s ease-in-out infinite; animation-delay: 1s }
                    .shimmer-3 { animation: facet-shimmer 3s ease-in-out infinite; animation-delay: 2s }
                    .sparkle { transform-origin: center; animation: sparkle-pop 2.5s ease-in-out infinite }
                    .sparkle:nth-child(2) { animation-delay: .8s }
                    .sparkle:nth-child(3) { animation-delay: 1.6s }
                </style>
                <g class="gem-body">
                    <polygon points="12,22 4,10 20,10" fill="url(#gf1)" />
                    <polygon points="4,10 8,3 12,6 12,10" fill="url(#gf2)" />
                    <polygon points="20,10 16,3 12,6 12,10" fill="url(#gf3)" />
                    <polygon points="8,3 12,1.5 16,3 12,6" fill="#e63946" />
                    <polygon points="4,10 12,10 12,22" fill="url(#gf2)" opacity=".7" />
                    <polygon points="20,10 12,10 12,22" fill="url(#gf1)" opacity=".8" />
                    <polygon class="shimmer-1" points="4,10 12,10 12,22" fill="white" opacity="0" />
                    <polygon class="shimmer-2" points="20,10 12,10 12,22" fill="white" opacity="0" />
                    <polygon class="shimmer-3" points="8,3 12,1.5 16,3 12,6" fill="white" opacity="0" />
                </g>
                <g>
                    <circle class="sparkle" cx="3" cy="5" r=".8" fill="white" opacity="0" />
                    <circle class="sparkle" cx="21" cy="4" r=".6" fill="white" opacity="0" />
                    <circle class="sparkle" cx="22" cy="16" r=".7" fill="white" opacity="0" />
                </g>
            </svg>
            Built by GarnetGrid
        </a>
    </div>
</body>

</html>